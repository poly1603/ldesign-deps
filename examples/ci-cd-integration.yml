# CI/CD é›†æˆç¤ºä¾‹ - GitHub Actions

name: Dependency Management

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 9 ç‚¹æ‰§è¡Œ
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # ä¾èµ–æ£€æŸ¥å’Œå®¡è®¡
  dependency-check:
    runs-on: ubuntu-latest
    name: Dependency Check & Audit
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install @ldesign/deps
        run: npm install -g @ldesign/deps
      
      # å®‰å…¨å®¡è®¡
      - name: Security Audit
        id: audit
        run: |
          ldeps audit --level high --json > audit-report.json
          echo "audit_status=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Upload Audit Report
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-report
          path: audit-report.json
      
      # æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
      - name: Check Outdated Dependencies
        run: ldeps outdated
      
      # æ£€æŸ¥é‡å¤ä¾èµ–
      - name: Check Duplicate Dependencies
        run: ldeps duplicate
      
      # ä¾èµ–åˆ†æ
      - name: Analyze Dependencies
        run: ldeps analyze
      
      # ç”Ÿæˆä¾èµ–å›¾
      - name: Generate Dependency Graph
        run: ldeps graph --format mermaid --output deps-graph.md
      
      - name: Upload Dependency Graph
        uses: actions/upload-artifact@v3
        with:
          name: dependency-graph
          path: deps-graph.md
      
      # æ£€æŸ¥å®¡è®¡ç»“æœ
      - name: Check Audit Results
        if: steps.audit.outputs.audit_status != '0'
        run: |
          echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼è¯·æŸ¥çœ‹å®¡è®¡æŠ¥å‘Šã€‚"
          exit 1

  # è‡ªåŠ¨æ›´æ–°è¡¥ä¸ç‰ˆæœ¬
  auto-update-patches:
    runs-on: ubuntu-latest
    name: Auto Update Patch Versions
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install @ldesign/deps
        run: npm install -g @ldesign/deps
      
      - name: Check for patch updates
        id: check
        run: |
          ldeps check --json > updates.json
          cat updates.json
      
      - name: Update patch versions
        run: |
          # æå–è¡¥ä¸æ›´æ–°å¹¶æ›´æ–°
          jq -r '.[] | select(.updateType == "patch") | .packageName' updates.json | \
            xargs -I {} ldeps update {} --dry-run
      
      - name: Run tests
        run: npm test
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): auto update patch versions'
          title: 'ğŸ¤– è‡ªåŠ¨æ›´æ–°è¡¥ä¸ç‰ˆæœ¬'
          body: |
            ## è‡ªåŠ¨ä¾èµ–æ›´æ–°
            
            æœ¬ PR ç”±è‡ªåŠ¨åŒ–æµç¨‹åˆ›å»ºï¼Œæ›´æ–°äº†ä»¥ä¸‹è¡¥ä¸ç‰ˆæœ¬ï¼š
            
            è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æäº¤è®°å½•ã€‚
            
            ### æ£€æŸ¥æ¸…å•
            - [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡
            - [x] å®‰å…¨å®¡è®¡æ— é—®é¢˜
            - [ ] éœ€è¦äººå·¥å®¡æŸ¥
          branch: deps/auto-update-patches
          delete-branch: true

  # Monorepo æ£€æŸ¥ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
  monorepo-check:
    runs-on: ubuntu-latest
    name: Monorepo Workspace Check
    if: contains(fromJson('["main", "develop"]'), github.ref_name)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install @ldesign/deps
        run: npm install -g @ldesign/deps
      
      - name: Check workspace
        run: ldeps workspace --scan || echo "Not a monorepo"
      
      - name: Analyze version conflicts
        run: ldeps workspace --analyze || echo "Not a monorepo"

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    runs-on: ubuntu-latest
    name: Performance Benchmark
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install @ldesign/deps
        run: npm install -g @ldesign/deps
      
      - name: Benchmark dependency check
        run: |
          echo "## æ€§èƒ½åŸºå‡†æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          
          # é¡ºåºæ£€æŸ¥
          SEQUENTIAL_TIME=$(time ( ldeps check ) 2>&1 | grep real | awk '{print $2}')
          echo "- é¡ºåºæ£€æŸ¥: $SEQUENTIAL_TIME" >> $GITHUB_STEP_SUMMARY
          
          # å¹¶è¡Œæ£€æŸ¥
          PARALLEL_TIME=$(time ( ldeps check --parallel ) 2>&1 | grep real | awk '{print $2}')
          echo "- å¹¶è¡Œæ£€æŸ¥: $PARALLEL_TIME" >> $GITHUB_STEP_SUMMARY

  # ä¾èµ–å˜æ›´é€šçŸ¥
  dependency-change-notification:
    runs-on: ubuntu-latest
    name: Notify Dependency Changes
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout base
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}
          path: base
      
      - name: Checkout head
        uses: actions/checkout@v3
        with:
          path: head
      
      - name: Compare dependencies
        run: |
          diff base/package.json head/package.json || true
      
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const basePackage = JSON.parse(fs.readFileSync('base/package.json', 'utf8'));
            const headPackage = JSON.parse(fs.readFileSync('head/package.json', 'utf8'));
            
            // æ¯”è¾ƒä¾èµ–å˜æ›´
            const changes = [];
            
            // ... ä¾èµ–æ¯”è¾ƒé€»è¾‘
            
            if (changes.length > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '## ğŸ“¦ ä¾èµ–å˜æ›´\n\n' + changes.join('\n')
              });
            }

